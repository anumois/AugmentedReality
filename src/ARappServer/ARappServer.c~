/*************************************************
 *                                               *
 * ARappServer.c                                 *
 * Made by Gihond Do at 2017.7.31                *
 * Main function for Game server used by ARapp   *
 *                                               *
 *************************************************/

// Commonly used Headers

#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <errno.h>
#include <string.h>
#include <sys/types.h>
#include <time.h>

// Headers for Networking

#include <sys/socket.h>
#include <netinet/in.h>
#include <netdb.h>
#include <arpa/inet.h>

// Headers for Multi-Process programming

#include <sys/wait.h>
#include <signal.h>

// Headers for Initialization

#include "ARappServer.h"
#include "ASsetup.h"
#include "ASSharedData.h"

// Headers for Implemented Functions

#include "ASSocket.h"
#include "ASMessage.h"

// Functions

static void ARAS_sigchld_handler(int s);
static void ARAS_Game(void);
static void *ARAS_get_in_addr(struct sockaddr *ARAS_sa);

// int main(void)
// Main function for Game Server 
int main(void)
{
  int ARAS_Server_Sockfd, ARAS_Client_Sockfd[4];
  int ARAS_Client_Count = 0;
  int ARAS_PID;
  struct sockaddr_storage ARAS_Their_Addr;
  socklen_t ARAS_Sin_Size;
  struct sigaction ARAS_Chldsa;

  char ARAS_Addr_String[INET6_ADDRSTRLEN];
  
  //Network Initialization
  if(!ASsetup_Network_Init(&ARAS_Server_Sockfd))
    {
      fprintf(stderr,"Network Initialization failed\n");
      return AS_FALSE;
    }

  //Shared Data Initialization
  ASSD_Init();
  
  ARAS_Chldsa.sa_handler = ARAS_sigchld_handler;
  sigemptyset(&ARAS_Chldsa.sa_mask);
  ARAS_Chldsa.sa_flags = SA_RESTART;
  
  if(sigaction(SIGCHLD, &ARAS_Chldsa, NULL) == -1)
    {
      fprintf(stderr, "sigaction\n");
      return AS_FALSE;
    }
  
  while(ARAS_Client_Count < 4)
    {
      printf("Waiting for Connection...\n");
      ARAS_Sin_Size = sizeof(ARAS_Their_Addr);
      if((ARAS_Client_Sockfd[ARAS_Client_Count] = accept(ARAS_Server_Sockfd,
				      (struct sockaddr *) &ARAS_Their_Addr,
				      &ARAS_Sin_Size)) == -1)
	{
	  fprintf(stderr, "accept\n");
	  continue;
	}
      
      inet_ntop(ARAS_Their_Addr.ss_family,
		ARAS_get_in_addr((struct sockaddr *)&ARAS_Their_Addr),
		ARAS_Addr_String,
		sizeof(ARAS_Addr_String));
      printf("server: got connection from %s\n", ARAS_Addr_String);

      //Child Process
      if(!(ARAS_PID = fork()))
	{
	  close(ARAS_Server_Sockfd);
	  ASCK_Server(ARAS_Client_Sockfd[ARAS_Client_Count]);
	  break;
	}

      ARAS_Client_Count++;
      
    }

  if(ARAS_PID)
    {
      ASsetup_Game_Init(ARAS_Client_Sockfd);
      ARAS_Game();
    }
  
}

static void ARAS_sigchld_handler(int s)
{
  int saved_errno = errno;
  while(waitpid(-1, NULL, WNOHANG) > 0);

  errno = saved_errno;
}

static void ARAS_Game()
{
  for(;;)
    {
      ASSD_Acquire_Lock();
      ASM_Broadcast();
      ASSD_Release_Lock();

      sleep(1);
    }
}
static void *ARAS_get_in_addr(struct sockaddr *ARAS_sa)
{
  if(ARAS_sa ->sa_family == AF_INET)
    {
      return &(((struct sockaddr_in *) ARAS_sa) -> sin_addr);
    }

  return &(((struct sockaddr_in6 *) ARAS_sa) -> sin6_addr);
}

